<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workway</title>
    <style>
        /* Einfaches Design für die Buttons */
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            margin-left: 10px;
            border-radius: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #result {
            margin-top: 20px;
            font-size: 20px;
        }
        #placesInputContainer {
            margin-bottom: 20px;
        }
        .placesInputRow {
            display: flex;
            align-items: center;
        }
        .placesInputRow input {
            margin-right: 10px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <h1>Arbeitsweg Rechner</h1>
    <div id="placesInputContainer" class="placesInputRow">
        <input type="text" id="placesInput" placeholder="Gib die Orte ein, z.B. Olpe, Siegen, Kirchveischede">
        <button onclick="calculateRoute()">Berechnen</button>
        <button onclick="copyPlaces()">Kopieren Orte</button>
    </div>

    <div id="result">
        <!-- Das Ergebnis der Berechnung wird hier erscheinen -->
    </div>

    <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>

    <script>
        let geojsonData = {};  // Hier wird später das GeoJSON geladen
        let markers = []; // Array für die Marker

        // Simuliertes GeoJSON für Testzwecke
        geojsonData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": { "name": "Olpe" },
                    "geometry": { "type": "Point", "coordinates": [7.8661, 51.0828] }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "Siegen" },
                    "geometry": { "type": "Point", "coordinates": [8.0235, 50.8757] }
                },
                {
                    "type": "Feature",
                    "properties": { "name": "Kirchveischede" },
                    "geometry": { "type": "Point", "coordinates": [7.9748, 51.0822] }
                }
            ]
        };

        // Berechnung der Route und der Distanzen
        function calculateRoute() {
            const inputField = document.getElementById('placesInput');
            const places = inputField.value.split(',').map(place => place.trim());

            if (places.length < 2) {
                alert("Bitte mindestens zwei Orte eingeben!");
                return;
            }

            const coordinates = [];
            for (let i = 0; i < places.length; i++) {
                const place = places[i];
                const coords = getCoordinatesFromGeoJson(place);
                if (coords) {
                    coordinates.push(coords);
                } else {
                    alert(`Kein Ergebnis für: ${place}`);
                    return;
                }
            }

            let totalDistance = 0;
            let routePromises = [];
            for (let i = 0; i < coordinates.length - 1; i++) {
                const start = coordinates[i];
                const end = coordinates[i + 1];

                routePromises.push(
                    getRoute(start, end).then(distance => {
                        console.log(`Berechnete Distanz von ${start} nach ${end}: ${distance} km`);  // Debugging: Distanz anzeigen
                        totalDistance += distance;
                    })
                );
            }

            Promise.all(routePromises).then(() => {
                console.log('Gesamte Distanz: ', totalDistance);  // Debugging: Gesamte Distanz anzeigen
                displayResult(totalDistance);
            });
        }

        // Holen der Koordinaten für die Orte aus der GeoJSON
        function getCoordinatesFromGeoJson(placeName) {
            const feature = geojsonData.features.find(f => f.properties.name.toLowerCase() === placeName.toLowerCase());
            if (feature) {
                return feature.geometry.coordinates;
            }
            return null;
        }

        // Holen der Route und Berechnung der Distanz
        function getRoute(startCoords, endCoords) {
            const url = `https://api.openstreetmap.org/routing/v1/route?start=${startCoords[1]},${startCoords[0]}&end=${endCoords[1]},${endCoords[0]}&format=json`;

            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('API Antwort:', data);  // Debugging: API Antwort überprüfen
                    if (data.routes && data.routes.length > 0) {
                        const distance = data.routes[0].legs[0].distance / 1000; // in km
                        console.log(`Distanz: ${distance} km`);  // Debugging: Berechnete Distanz
                        return distance;
                    } else {
                        throw new Error('Keine Route gefunden');
                    }
                })
                .catch(error => {
                    console.error('Fehler beim Abrufen der Route:', error);
                    return 0; // im Fehlerfall 0 zurückgeben
                });
        }

        // Das Ergebnis der Berechnung anzeigen
        function displayResult(totalDistance) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                Die gesamte Entfernung beträgt: ${totalDistance.toFixed(2)} km
                <button onclick="copyToClipboard('${totalDistance.toFixed(2)} km')">Kopieren</button>
            `;
        }

        // Die Kopieren-Funktion
        function copyToClipboard(text) {
            const tempInput = document.createElement("input");
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand("copy");
            document.body.removeChild(tempInput);
            alert("Kopiert: " + text);
        }

        // Orte kopieren
        function copyPlaces() {
            const inputField = document.getElementById('placesInput');
            copyToClipboard(inputField.value);
        }

        // Karte mit Leaflet einbinden
        function initMap() {
            const map = L.map('map').setView([51.0828, 7.8661], 10);  // Default auf Olpe

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Marker nur nach der Berechnung hinzufügen
            document.getElementById("placesInput").addEventListener("focus", removeMarkers); // Entferne Marker, wenn der Fokus auf das Eingabefeld gelegt wird
            addMarkers();
        }

        // Karte initialisieren
        initMap();
    </script>
</body>
</html>
